<html lang="en">
<head>
    <title>Operator - Mosquitto</title>
    <meta charset="utf-8"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript" crossorigin="anonymous"></script>
    <link href="style.css" rel="stylesheet">
    <script type="text/javascript">
        let mqtt;
        let reconnectTimeout = 2000;
        let host = "127.0.0.1";
        let port = 9001;

        function onFailure(message) {
            console.log("Connection attempt failed");
            setTimeout(MQTTconnect, reconnectTimeout);
        }

        function onMessageArrived(msg) {
            // console.log(msg.payloadString);
            let op = document.getElementById("output");
            if(msg.payloadString.match(/\d{10}: .*/i)) {
                op.value += msg.payloadString + "\n";
            } else {
                op.value += ~~(Date.now()/1000) + " (" + msg.destinationName + "): " + msg.payloadString + "\n";
            }
            op.scrollTop = op.scrollHeight;
        }

        function onConnect() {
            console.log("Connected");
            mqtt.subscribe("$SYS/broker/log/#");
        }

        function MQTTconnect() {
            console.log("Connecting to " + host + ":" + port + "...");
            mqtt = new Paho.MQTT.Client(host, port, "", "ws-client");
            let options = {timeout: 3, onSuccess: onConnect, onFailure: onFailure};
            mqtt.onMessageArrived = onMessageArrived;
            mqtt.connect(options);
        }

        function onSubscribe(topic, button) {
            mqtt.subscribe(topic + "/#");
            button.setAttribute("onClick", "onUnsubscribe('" + topic + "', this)");
            document.getElementById("son").appendChild(button);
        }
        
        function onUnsubscribe(topic, button) {
            mqtt.unsubscribe(topic + "/#");
            button.setAttribute("onClick", "onSubscribe('" + topic + "', this)");
            document.getElementById("soff").appendChild(button);
        }
    </script>
</head>
<body>
<nav>
    <div class="navitem"><a href="index.html">Control</a></div>
    <div class="navitem"><a href="cameras.html">Cameras</a></div>
    <div class="navitem selected"><a href="debug.html">Mosquitto</a></div>
</nav>
<textarea id="output" readonly></textarea>
<footer>
    <div id="soff" class="subs off">
        <button onclick="onSubscribe('1', this)">1</button>
        <button onclick="onSubscribe('2', this)">2</button>
        <button onclick="onSubscribe('3', this)">3</button>
        <button onclick="onSubscribe('4', this)">4</button>
        <button onclick="onSubscribe('5', this)">5</button>
        <button onclick="onSubscribe('6', this)">6</button>
        <button onclick="onSubscribe('7', this)">7</button>
        <button onclick="onSubscribe('8', this)">8</button>
    </div>
    <div id="son" class="subs on">
        <button onclick="onUnsubscribe('$SYS/broker/log', this)">$SYS/broker/log</button>
    </div>
</footer>
<script>MQTTconnect();</script>
</body>
</html>
