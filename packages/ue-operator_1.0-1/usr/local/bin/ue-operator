#!/usr/bin/env python3

from argparse import ArgumentParser
import subprocess


if __name__ == "__main__":
    parser = ArgumentParser(description='Command-line interface for the ubilab-escape operator')
    parser.add_argument('command', metavar='CMD', type=str, choices=["init", "start", "help"], nargs="?",
                        help='the command to execute', default="help")
    parser.add_argument("-v", '--verbose', action='store_true', default=False, help='outputs debug information')
    parser.add_argument('--version', action='version', version='%(prog)s 1.0-1')
    args = parser.parse_args()
    v = args.verbose

    try:
        """
            Initializing the network and stuff
        """
        if args.command == "init":
            if v:
                print("Operator initiated")

        """
            Starting all services and scripts
        """
        if args.command == "start":
            if v:
                print("Operator started")
            p = subprocess.Popen(["mosquitto", "-c", "../../../opt/ue-operator/mosquitto.conf"], stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
            for line in iter(p.stdout.readline, b''):
                print(line.decode("UTF-8"), end="")

        """
            Outputting the help
        """
        if args.command == "help":
            print("Select a CMD: init, start")
            parser.parse_args(["--help"])
            exit(1)
    except KeyboardInterrupt:
        print("Operator ended by user")
        exit(0)
